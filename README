# pypolca-reprocess

A standalone command-line tool for re-generating the consensus sequences (output fasta) from modified VCF files generated by [`pypolca`](https://github.com/gbouras13/pypolca). This script has been created by modifying code from the [`pypolca` repository](https://github.com/gbouras13/pypolca).

We found that when attempting to use `pypolca` to polish MAGs, occasionally, there are cases of mis-corrections due to the presence of related sequences from other organisms mapping to conserved sequences, esp. rRNA genes. This script allows the user to edit the intermediate VCF generated by `pypolca` and quickly create a new consensus fasta.


## Requirements

This script relies on the same dependencies as [`pypolca`](https://github.com/gbouras13/pypolca), and it's recommended to use it from the same environment you have `pypolca` installed.

The following Python packages must be available in your environment:
- `biopython` (Bio module for sequence handling)
- `loguru` (for logging)
- `pathlib` (usually included with Python 3.4+)

## Usage

### Basic Usage
```bash
./pypolca-reprocess.py -r reference.fasta -v variants.vcf -o corrected.fasta
```

### Advanced Usage
```bash
# Set custom thresholds (same as pypolca --careful)
./pypolca-reprocess.py -r ref.fa -v vars.vcf -o out.fa --min_alt 4 --min_ratio 3

# Homopolymer-only mode (only fix homopolymers >= 5bp)
./pypolca-reprocess.py -r ref.fa -v vars.vcf -o out.fa --homopolymers 5

# Verbose logging
./pypolca-reprocess.py -r ref.fa -v vars.vcf -o out.fa --verbose

# Quiet mode (errors only)
./pypolca-reprocess.py -r ref.fa -v vars.vcf -o out.fa --quiet
```

## Command Line Options

Users should use the same arguments as their default `pypolca` runs. Note that it doesn't include pre-set arguments, e.g. for `pypolca`'s `--careful` flag, you need to specify the actual parameters: `--min_alt 4 --min_ratio 3`.

### Required Arguments
- `-r, --reference`: Path to reference/input contigs in FASTA format
- `-v, --vcf`: Path to VCF file containing variants
- `-o, --output`: Path to output corrected FASTA file

### Optional Arguments
- `--min-alt`: Minimum number of alternative allele observations (default: 2)
- `--min-ratio`: Minimum ratio of alternative to reference alleles (default: 0.5)
- `--homopolymers`: Only fix homopolymer changes of at least this length (optional)
- `--verbose, -V`: Enable verbose logging
- `--quiet, -q`: Suppress all output except errors
- `--version`: Show version information
- `--help`: Show help message


## Installation

Simply copy the `pypolca-reprocess.py` script to your desired location, e.g. add it to your `pypolca` folder, and make it executable:

```bash
chmod +x pypolca-reprocess.py
```
